
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub JSON 管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsonlint@1.6.3/web/jsonlint.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .editor-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-md;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark text-dark dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- 顶部导航 -->
    <header class="bg-white dark:bg-gray-900 shadow-sm sticky top-0 z-50 transition-colors duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-github text-2xl text-primary"></i>
                <h1 class="text-xl font-bold">GitHub JSON 管理器</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 btn-hover">
                    <i class="fa fa-moon-o dark:hidden text-lg"></i>
                    <i class="fa fa-sun-o hidden dark:inline text-lg"></i>
                </button>
                <button id="helpBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 btn-hover" title="帮助">
                    <i class="fa fa-question-circle text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- 仓库配置区域（已改为可编辑） -->
        <section class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 mb-6 card-hover">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-cog text-primary mr-2"></i>仓库配置
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">GitHub 用户名</label>
                    <input type="text" id="username" value="qyxay"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-dark dark:text-gray-100 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">仓库名称</label>
                    <input type="text" id="repo" value="hsy_search"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-dark dark:text-gray-100 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">文件路径</label>
                    <input type="text" id="filePath" value="资料库.json"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-dark dark:text-gray-100 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">分支名称</label>
                    <input type="text" id="branch" value="main"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-dark dark:text-gray-100 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300">
                </div>
                <div class="md:col-span-2 lg:col-span-1"></div>
                <div class="md:col-span-2 lg:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Personal Access Token</label>
                    <div class="relative">
                        <input type="password" id="token" value="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"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-white dark:bg-gray-800 text-dark dark:text-gray-100 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300">
                        <button id="showToken" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                            <i class="fa fa-eye-slash"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-3">
                <button id="connectBtn" class="px-4 py-2 bg-primary text-white rounded-md flex items-center btn-hover">
                    <i class="fa fa-plug mr-2"></i>验证连接
                </button>
                <button id="saveConfigBtn" class="px-4 py-2 bg-secondary text-white rounded-md flex items-center btn-hover">
                    <i class="fa fa-save mr-2"></i>保存配置
                </button>
                <button id="clearConfigBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md flex items-center btn-hover">
                    <i class="fa fa-trash mr-2"></i>清除配置
                </button>
            </div>
            <div id="connectionStatus" class="mt-3 hidden"></div>
        </section>

        <!-- 操作按钮区域 -->
        <section class="flex flex-wrap gap-3 mb-6">
            <button id="fetchBtn" class="px-4 py-2 bg-success text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-download mr-2"></i>获取JSON内容
            </button>
            <button id="formatBtn" class="px-4 py-2 bg-warning text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-indent mr-2"></i>格式化JSON
            </button>
            <button id="validateBtn" class="px-4 py-2 bg-primary text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-check mr-2"></i>验证JSON
            </button>
            <button id="saveBtn" class="px-4 py-2 bg-danger text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-upload mr-2"></i>保存到GitHub
            </button>
            <button id="createBtn" class="px-4 py-2 bg-secondary text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-plus mr-2"></i>创建新文件
            </button>
            <button id="deleteBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover">
                <i class="fa fa-trash mr-2"></i>删除文件
            </button>
        </section>

        <!-- 编辑器区域 -->
        <section class="bg-white dark:bg-gray-900 rounded-lg shadow-md mb-6 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-800">
                <h2 class="text-lg font-semibold flex items-center">
                    <i class="fa fa-code text-primary mr-2"></i>JSON编辑器
                </h2>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <span id="charCount">0</span> 字符
                    </div>
                    <div id="jsonStatus" class="hidden"></div>
                </div>
            </div>
            <div class="p-1">
                <textarea id="jsonEditor" class="w-full h-[500px] p-4 bg-gray-50 dark:bg-gray-800 border-0 rounded-md font-mono text-sm focus:ring-2 focus:ring-primary/50 outline-none transition-colors duration-300"
                    placeholder="JSON内容将显示在这里..."></textarea>
            </div>
        </section>

        <!-- 提交信息区域 -->
        <section id="commitSection" class="bg-white dark:bg-gray-900 rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-comment text-primary mr-2"></i>提交信息
            </h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">提交标题</label>
                <input type="text" id="commitTitle" placeholder="请输入提交标题（例如：更新JSON内容）"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800 text-dark dark:text-gray-100">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">提交描述（可选）</label>
                <textarea id="commitDescription" rows="3" placeholder="请输入详细的提交描述（可选）"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800 text-dark dark:text-gray-100"></textarea>
            </div>
            <div class="flex justify-end">
                <button id="confirmSaveBtn" class="px-4 py-2 bg-success text-white rounded-md flex items-center btn-hover">
                    <i class="fa fa-check mr-2"></i>确认保存
                </button>
            </div>
        </section>

        <!-- 消息提示区域 -->
        <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 rounded-md shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50"></div>
    </main>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-3xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-800">
                <h3 class="text-xl font-bold">使用帮助</h3>
                <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-primary">1. 基本介绍</h4>
                    <p class="mb-2">这个工具可以帮助您读取和修改GitHub仓库中的JSON文件，特别优化了中文显示效果。</p>
                    <p>您可以修改所有配置项：用户名、仓库、文件路径、分支和访问令牌。</p>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-primary">2. 使用步骤</h4>
                    <ol class="list-decimal list-inside space-y-2 pl-4">
                        <li>填写或修改GitHub配置信息（用户名、仓库、文件路径、分支、访问令牌）</li>
                        <li>点击"验证连接"按钮确认与GitHub仓库的连接</li>
                        <li>点击"获取JSON内容"按钮加载仓库中的JSON文件</li>
                        <li>在编辑器中修改JSON内容（支持中文）</li>
                        <li>可使用"格式化JSON"和"验证JSON"按钮确保格式正确</li>
                        <li>点击"保存到GitHub"按钮，填写提交信息后确认保存</li>
                    </ol>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-primary">3. 注意事项</h4>
                    <ul class="list-disc list-inside space-y-2 pl-4">
                        <li>确保您的GitHub令牌具有仓库的读写权限</li>
                        <li>修改前建议先获取最新的JSON内容，避免冲突</li>
                        <li>删除文件操作不可逆，请谨慎使用</li>
                        <li>所有操作都会直接提交到GitHub仓库，请确认修改内容正确</li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3 text-primary">4. 常见问题</h4>
                    <div class="space-y-4">
                        <div>
                            <p class="font-medium">Q: 中文显示乱码怎么办？</p>
                            <p>A: 本工具已优化中文编码处理，确保中文内容正确显示和保存。</p>
                        </div>
                        <div>
                            <p class="font-medium">Q: 保存失败怎么办？</p>
                            <p>A: 请检查令牌权限、网络连接和文件路径是否正确。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM元素
        const themeToggle = document.getElementById('themeToggle');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const jsonEditor = document.getElementById('jsonEditor');
        const charCount = document.getElementById('charCount');
        const jsonStatus = document.getElementById('jsonStatus');
        const fetchBtn = document.getElementById('fetchBtn');
        const formatBtn = document.getElementById('formatBtn');
        const validateBtn = document.getElementById('validateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const createBtn = document.getElementById('createBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const commitSection = document.getElementById('commitSection');
        const commitTitle = document.getElementById('commitTitle');
        const commitDescription = document.getElementById('commitDescription');
        const confirmSaveBtn = document.getElementById('confirmSaveBtn');
        const toast = document.getElementById('toast');
        const usernameInput = document.getElementById('username');
        const repoInput = document.getElementById('repo');
        const filePathInput = document.getElementById('filePath');
        const branchInput = document.getElementById('branch');
        const tokenInput = document.getElementById('token');
        const showTokenBtn = document.getElementById('showToken');
        const connectBtn = document.getElementById('connectBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const clearConfigBtn = document.getElementById('clearConfigBtn');
        const connectionStatus = document.getElementById('connectionStatus');

        // 全局变量
        let fileSha = null; // 文件的SHA值，用于更新文件
        let isTokenVisible = false;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查主题设置
            if (localStorage.getItem('theme') === 'dark' || 
                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            // 加载配置
            loadConfig();

            // 编辑器字符计数
            jsonEditor.addEventListener('input', updateCharCount);
            updateCharCount();

            // 绑定事件
            bindEvents();
        });

        // 绑定事件
        function bindEvents() {
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);

            // 帮助模态框
            helpBtn.addEventListener('click', showHelpModal);
            closeHelpBtn.addEventListener('click', hideHelpModal);
            helpModal.addEventListener('click', function(e) {
                if (e.target === helpModal) hideHelpModal();
            });

            // 编辑器操作
            fetchBtn.addEventListener('click', fetchJson);
            formatBtn.addEventListener('click', formatJson);
            validateBtn.addEventListener('click', validateJson);
            saveBtn.addEventListener('click', showCommitSection);
            confirmSaveBtn.addEventListener('click', saveJson);
            createBtn.addEventListener('click', createNewFile);
            deleteBtn.addEventListener('click', deleteFile);

            // 配置操作
            showTokenBtn.addEventListener('click', toggleTokenVisibility);
            connectBtn.addEventListener('click', testConnection);
            saveConfigBtn.addEventListener('click', saveConfig);
            clearConfigBtn.addEventListener('click', clearConfig);
        }

        // 主题切换
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // 显示帮助模态框
        function showHelpModal() {
            helpModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 隐藏帮助模态框
        function hideHelpModal() {
            helpModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 更新字符计数
        function updateCharCount() {
            charCount.textContent = jsonEditor.value.length;
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-md shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center z-50';
            
            switch(type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-danger', 'text-white');
                    break;
                case 'warning':
                    toast.classList.add('bg-warning', 'text-white');
                    break;
                default:
                    toast.classList.add('bg-primary', 'text-white');
            }

            setTimeout(() => {
                toast.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-md shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50';
            }, 3000);
        }

        // 显示JSON状态
        function showJsonStatus(message, type = 'info') {
            jsonStatus.textContent = message;
            jsonStatus.className = 'inline-flex items-center px-2 py-1 rounded text-xs font-medium';
            
            switch(type) {
                case 'success':
                    jsonStatus.classList.add('bg-success/10', 'text-success');
                    break;
                case 'error':
                    jsonStatus.classList.add('bg-danger/10', 'text-danger');
                    break;
                case 'warning':
                    jsonStatus.classList.add('bg-warning/10', 'text-warning');
                    break;
                default:
                    jsonStatus.classList.add('bg-primary/10', 'text-primary');
            }

            jsonStatus.classList.remove('hidden');
        }

        // 隐藏JSON状态
        function hideJsonStatus() {
            jsonStatus.classList.add('hidden');
        }

        // 显示连接状态
        function showConnectionStatus(message, type = 'info') {
            connectionStatus.textContent = message;
            connectionStatus.className = 'p-3 rounded text-sm';
            
            switch(type) {
                case 'success':
                    connectionStatus.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
                    break;
                case 'error':
                    connectionStatus.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
                    break;
                case 'warning':
                    connectionStatus.classList.add('bg-warning/10', 'text-warning', 'border', 'border-warning/30');
                    break;
                default:
                    connectionStatus.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
            }

            connectionStatus.classList.remove('hidden');
        }

        // 隐藏连接状态
        function hideConnectionStatus() {
            connectionStatus.classList.add('hidden');
        }

        // 切换令牌可见性
        function toggleTokenVisibility() {
            isTokenVisible = !isTokenVisible;
            tokenInput.type = isTokenVisible ? 'text' : 'password';
            showTokenBtn.innerHTML = isTokenVisible ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
        }

        // 测试连接
        async function testConnection() {
            const username = usernameInput.value.trim();
            const repo = repoInput.value.trim();
            const token = tokenInput.value.trim();

            if (!username || !repo || !token) {
                showConnectionStatus('请填写完整的配置信息', 'error');
                return;
            }

            try {
                showConnectionStatus('正在验证连接...', 'info');
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    showConnectionStatus('连接验证成功！', 'success');
                } else if (response.status === 401) {
                    showConnectionStatus('连接验证失败：无效的访问令牌', 'error');
                } else if (response.status === 403) {
                    showConnectionStatus('连接验证失败：令牌权限不足', 'error');
                } else if (response.status === 404) {
                    showConnectionStatus('连接验证失败：仓库不存在', 'error');
                } else {
                    showConnectionStatus(`连接验证失败：${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showConnectionStatus(`连接验证失败：${error.message}`, 'error');
            }
        }

        // 保存配置
        function saveConfig() {
            const config = {
                username: usernameInput.value.trim(),
                repo: repoInput.value.trim(),
                filePath: filePathInput.value.trim(),
                branch: branchInput.value.trim(),
                token: tokenInput.value.trim()
            };

            localStorage.setItem('githubJsonConfig', JSON.stringify(config));
            showToast('配置已保存！', 'success');
        }

        // 加载配置
        function loadConfig() {
            const config = localStorage.getItem('githubJsonConfig');
            if (config) {
                const { username, repo, filePath, branch, token } = JSON.parse(config);
                if (username) usernameInput.value = username;
                if (repo) repoInput.value = repo;
                if (filePath) filePathInput.value = filePath;
                if (branch) branchInput.value = branch;
                if (token) tokenInput.value = token;
            }
        }

        // 清除配置
        function clearConfig() {
            if (confirm('确定要清除所有配置吗？')) {
                localStorage.removeItem('githubJsonConfig');
                usernameInput.value = '';
                repoInput.value = '';
                filePathInput.value = '';
                branchInput.value = 'main';
                tokenInput.value = '';
                hideConnectionStatus();
                showToast('配置已清除！', 'success');
            }
        }

        // 获取JSON内容
        async function fetchJson() {
            const username = usernameInput.value.trim();
            const repo = repoInput.value.trim();
            const filePath = filePathInput.value.trim();
            const branch = branchInput.value.trim();
            const token = tokenInput.value.trim();

            if (!username || !repo || !filePath || !token) {
                showToast('请填写完整的配置信息', 'error');
                return;
            }

            try {
                showToast('正在获取JSON内容...', 'info');
                const response = await fetch(
                    `https://api.github.com/repos/${username}/${repo}/contents/${filePath}?ref=${branch}`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    fileSha = data.sha;
                    
                    // 解码Base64内容，确保中文正确显示
                    const decodedContent = decodeURIComponent(escape(atob(data.content)));
                    jsonEditor.value = decodedContent;
                    updateCharCount();
                    showToast('JSON内容获取成功！', 'success');
                    validateJson();
                } else if (response.status === 404) {
                    showToast('文件不存在，可以创建新文件', 'warning');
                    jsonEditor.value = '{\n  \n}';
                    updateCharCount();
                    fileSha = null;
                } else if (response.status === 401) {
                    showToast('获取失败：无效的访问令牌', 'error');
                } else {
                    showToast(`获取失败：${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showToast(`获取失败：${error.message}`, 'error');
            }
        }

        // 格式化JSON
        function formatJson() {
            try {
                const parsed = JSON.parse(jsonEditor.value);
                jsonEditor.value = JSON.stringify(parsed, null, 2);
                updateCharCount();
                showJsonStatus('JSON格式化成功', 'success');
                setTimeout(hideJsonStatus, 3000);
                showToast('JSON格式化成功！', 'success');
            } catch (error) {
                showJsonStatus(`格式化失败：${error.message}`, 'error');
                setTimeout(hideJsonStatus, 3000);
                showToast(`格式化失败：${error.message}`, 'error');
            }
        }

        // 验证JSON
        function validateJson() {
            try {
                JSON.parse(jsonEditor.value);
                showJsonStatus('JSON格式正确', 'success');
                return true;
            } catch (error) {
                showJsonStatus(`JSON格式错误：${error.message}`, 'error');
                return false;
            }
        }

        // 显示提交信息区域
        function showCommitSection() {
            if (!validateJson()) {
                showToast('JSON格式错误，请先修复', 'error');
                return;
            }
            
            commitTitle.value = `更新 ${filePathInput.value.trim()}`;
            commitDescription.value = '';
            commitSection.classList.remove('hidden');
            commitTitle.focus();
        }

        // 保存JSON到GitHub
        async function saveJson() {
            const username = usernameInput.value.trim();
            const repo = repoInput.value.trim();
            const filePath = filePathInput.value.trim();
            const branch = branchInput.value.trim();
            const token = tokenInput.value.trim();
            const title = commitTitle.value.trim();
            const description = commitDescription.value.trim();
            const content = jsonEditor.value.trim();

            if (!title) {
                showToast('请输入提交标题', 'error');
                return;
            }

            if (!content) {
                showToast('JSON内容不能为空', 'error');
                return;
            }

            if (!validateJson()) {
                showToast('JSON格式错误，请先修复', 'error');
                return;
            }

            try {
                showToast('正在保存到GitHub...', 'info');
                
                // 编码内容为Base64，确保中文正确处理
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                const commitMessage = description ? `${title}\n\n${description}` : title;
                
                const requestData = {
                    message: commitMessage,
                    content: encodedContent,
                    branch: branch
                };

                // 如果是更新文件，需要提供SHA
                if (fileSha) {
                    requestData.sha = fileSha;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`,
                    {
                        method: fileSha ? 'PUT' : 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    }
                );

                const responseData = await response.json();

                if (response.ok) {
                    fileSha = responseData.content.sha;
                    commitSection.classList.add('hidden');
                    showToast('保存成功！', 'success');
                } else {
                    const errorMessage = responseData.message || `${response.status} ${response.statusText}`;
                    showToast(`保存失败：${errorMessage}`, 'error');
                }
            } catch (error) {
                showToast(`保存失败：${error.message}`, 'error');
            }
        }

        // 创建新文件
        function createNewFile() {
            if (confirm('确定要创建新文件吗？当前编辑器内容将会被清空。')) {
                jsonEditor.value = '{\n  \n}';
                updateCharCount();
                fileSha = null;
                showToast('请在编辑器中输入新的JSON内容', 'info');
                jsonEditor.focus();
            }
        }

        // 删除文件
        async function deleteFile() {
            if (!fileSha) {
                showToast('没有已加载的文件可以删除', 'error');
                return;
            }

            if (!confirm('确定要删除这个文件吗？此操作不可逆！')) {
                return;
            }

            const username = usernameInput.value.trim();
            const repo = repoInput.value.trim();
            const filePath = filePathInput.value.trim();
            const branch = branchInput.value.trim();
            const token = tokenInput.value.trim();

            try {
                showToast('正在删除文件...', 'info');
                
                const response = await fetch(
                    `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `删除 ${filePath}`,
                            sha: fileSha,
                            branch: branch
                        })
                    }
                );

                if (response.ok) {
                    jsonEditor.value = '';
                    updateCharCount();
                    fileSha = null;
                    hideJsonStatus();
                    showToast('文件删除成功！', 'success');
                } else {
                    const responseData = await response.json();
                    const errorMessage = responseData.message || `${response.status} ${response.statusText}`;
                    showToast(`删除失败：${errorMessage}`, 'error');
                }
            } catch (error) {
                showToast(`删除失败：${error.message}`, 'error');
            }
        }

        // 页面离开确认
        window.addEventListener('beforeunload', function(e) {
            if (jsonEditor.value.trim() && !fileSha) {
                e.preventDefault();
                e.returnValue = '您有未保存的更改，确定要离开吗？';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
